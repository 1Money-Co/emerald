# **Starting a New Network**

### **Overview**

This will cover all components for starting a new network.

---

## **Network Overview**

Required nodes to run for operations:

- Reth - execution client
- Emerald - consensus client

These two services will need to communicate with eachother and with other nodes in the network. Note: for best performance they should be on the same server.

![Network-Diagram](network-diagram.png)

---

## **Installing Emerald**

#### **Prerequisites**

- Rust - [https://rust-lang.org/tools/install/](https://rust-lang.org/tools/install/)

First clone the repo:

```
git clone https://github.com/informalsystems/emerald.git
cd emerald
cargo build --release
```

This will build the Emerald binary and place it under `target/release/emerald` which can then be copied to the desired machine under `/usr/local/bin/emerald` for example.

---

## **Creating Network Genesis**

**Create Private Keys**

First request that all validators create the private keys they will be using for the new network.

Private keys can be generated by running:

```
emerald init --home /path/to/home_dir
```

The signing key can now be found at `</path/to/home_dir/>config/priv_validator_key.json`.

The validator can then get the pubkey with the following command:

```
emerald show-pubkey </path/to/home_dir>/config/priv_validator_key.json
```

The pubkey that is output here is what the validator should provide to the network coordinator.

<br/><br/>

**Setup PoA (Proof of Authority) Address Key**

At this stage you should use the tool of your choice to create a private (hex) key that will be used to add/remove/update validators in the PoA chain.

You will need the `0x123abc...` address for the next step to define your address as the Authority over the validator set.

<br/><br/>

**Generate Genesis Files (for Reth and for Emerald)**

Before running the next command, take all of the validator public keys you have collected and place them in a file, for example validator_public_keys.txt.

**Place 1 public key per line like the following:**

```
0xd8620dd478f043bd27fc9389ec6873410265cf8640cb636decd2f0a2ddad7aa5656e58f05b1596a9c737f7073211089c6b49ab7ad5bdb9ab55bf83741b3ee4e4
0x9b9fc5d66ec179df923dfbb083f2e846ff5da508650c77473c8427fafe481a5e73c1ad26bed12895108f463b84f6dd0d8ebbf4270a06e312a3b63295cffebbff
0x317052004566d1d2ac0b3161313646412f93275599eb6455302a050352027905346eb4a0eebce874c35b1cd29bb5472c46eb2fd9ed24e57c2b73b85b59729e36
```

Now to create the genesis files, run:

```
emerald genesis \
  --public-keys-file /path/to/validator_public_keys.txt \
  --chain-id 12345 \
  --poa-owner-address <ADDRESS_GENERATED_IN_PREVIOUS_STEP> \
  --evm-genesis-output ./eth-genesis.json \
  --emerald-genesis-output ./emerald-genesis.json
```

This takes all of the public keys and creates the genesis file for Reth which includes the Proof of Authority smart contract and the genesis file for Emerald.

**Important**

Both of the above genesis files will be used, one for Reth and one for Emerald.

--

## **Running Reth (Execution Client)**

Reth is the Ethereum execution client. It handles transaction execution, state management, and provides JSON-RPC endpoints for interacting with the blockchain.

#### **Prerequisites**

- Reth binary installed (install from https://github.com/paradigmxyz/reth)
- Genesis file (`eth-genesis.json`) created for your network from previous step.

<br/><br/>

#### **Generate JWT Secret**

The JWT secret is required for authenticated communication between Reth (execution client) and Emerald (consensus engine) via the Engine API.

Generate a JWT secret using openssl:

```bash
openssl rand -hex 32
```
The random hex can be place in a file to be used for all Reth and Emerald nodes.

**Important**: The same JWT must be used by Reth and Emerald. Make sure Emerald is configured to use the same JWT.

<br/><br/>

#### **Start Reth Node**

Start Reth with the following configuration:

```bash
reth node \
  --chain /path/to/genesis.json \
  --datadir /var/lib/reth \
  --http \
  --http.addr 0.0.0.0 \
  --http.port 8545 \
  --http.api eth,net,web3,txpool,debug \
  --http.corsdomain "*" \
  --ws \
  --ws.addr 0.0.0.0 \
  --ws.port 8546 \
  --ws.api eth,net,web3,txpool,debug \
  --authrpc.addr 0.0.0.0 \
  --authrpc.port 8551 \
  --authrpc.jwtsecret /var/lib/reth/jwt.hex \
  --port 30303 \
  --metrics=0.0.0.0:9000
```

<br/><br/>

#### **Key Configuration Options**

- `--chain`: Path to genesis configuration file
- `--datadir`: Database and state storage directory
- `--http.*`: JSON-RPC HTTP endpoint configuration
- `--ws.*`: WebSocket endpoint configuration
- `--authrpc.*`: Authenticated Engine API for consensus client communication
- `--authrpc.jwtsecret`: Path to JWT secret file for Engine API authentication (must match Emerald's JWT)
- `--port`: P2P networking port for peer connections
- `--disable-discovery`: Disable peer discovery (useful for permissioned networks)

<br/><br/>

#### **Network Endpoints**

Once running, Reth provides the following endpoints:

- **HTTP RPC**: `http://<IP>:8545` - Standard Ethereum JSON-RPC
- **WebSocket**: `ws://<IP>:8546` - WebSocket subscriptions
- **Engine API**: `http://<IP>:8551` - Authenticated API for Emerald consensus
- **Metrics**: `http//<IP>:9000` - Prometheus Metrics Endpoint

<br/><br/>

#### **Connecting Peers (Optional)**

For multi-node networks, connect Reth instances as trusted peers:

```bash
# Get enode from node
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"admin_nodeInfo","params":[],"id":1}' \
  http://localhost:8545 | jq -r '.result.enode'

# Add trusted peer
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"admin_addTrustedPeer","params":["ENODE_URL"],"id":1}' \
  http://localhost:8545
```

**Note:** This requires `admin` to added to the `--http.api` flag and this will need to be done on all instances of Reth.

Another option is to use the `--trusted-peers` flag to reth and add the enode peer info like this for example:

```
--trusted-peers=enode://a0fd9e095d89320c27b2a07460f4046f63747e5b99ca14dd94475f65910bf0c67037fc1194a04d083afb13d61def3f6f1112757f514ca2fdabd566610658d030@PEER0_IP:30303,enode://add24465ccee48d97a0212afde6b2c0373c8b2b37a1f44c46be9d252896fe6c55256fd4bd8652cf5d41a11ffae1f7537922810b160a4fd3ed0c6f388d137587e@PEER1_IP:30303,enode://dde9a1240332360ac6588cb484cd9a0855c47324ea97eadaead51aed3fe8f9101d03f1b5ff587e7f80f6a2a25417f1425357d3f339d58826f05231fec22c5d7f@PEER2_IP:30303
```

<br/><br/>

#### **Systemd Service**

For remote deployments, you can use systemd to manage the Reth process. See [reth.systemd.service.example](reth.systemd.service.example) for a service configuration example.

---

## **Running Emerald (Consensus Engine)**

Emerald is the consensus client, built on Malachite BFT. It coordinates with Reth via the Engine API to produce blocks and achieve consensus across the validator network.

#### **Prerequisites**

- Emerald binaries built `emerald` (`cargo build --release` where binary can be found in path `target/release/emerald`)
- Node configuration directory created (contains `config.toml`, `emerald.toml`, and `priv_validator_key.json`) - Recommended to setup a user `emerald` and use a home folder like `/home/emerald/.emerald` and in there a config folder for all files.
- Reth node must be running with Engine API enabled
- JWT secret file (same as used by Reth)

<br/><br/>

#### **Configuration Files**

Each Emerald node requires two configuration files in its home directory:

**1. `config.toml` (MalachiteBFT Configuration)**

See [malachitebft-config.toml](malachitebft-config.toml) for a complete example. Key sections:

- **Consensus settings**: Block timing, timeouts, and consensus parameters
- **P2P networking**: Listen addresses and peer connections
  - Consensus P2P: Port 27000 (default)
    -  persistent_peers must be filled out for p2p
  - Mempool P2P: Port 28000 (default)
    -  persistent_peers must be filled out for p2p
- **Metrics**: Prometheus metrics endpoint on port 30000

This file must be in config folder in home_dir, example `/home/emerald/.emerald/config/config.toml` where --home flag would be defined as `--home=/home/emerald/.emerald`

**2. `emerald.toml` (Execution Integration)**

See [emerald-config.toml](emerald-config.toml) for a complete example. Key settings:

```toml
moniker = "validator-0"
execution_authrpc_address = "http://<RETH_IP>:8545"
engine_authrpc_address = "http://<RETH_IP>:8551"
jwt_token_path = "/path/to/jwt.hex"
el_node_type = "archive"
sync_timeout_ms = 1000000
sync_initial_delay_ms = 100
...
```

**Important**: The `jwt_token_path` must point to the same JWT token used by Reth.

<br/><br/>

#### **Configure Peer Connections**

For a multi-node network, configure persistent peers in `config.toml`:

```toml
[consensus.p2p]
listen_addr = "/ip4/0.0.0.0/tcp/27000"
persistent_peers = [
    "/ip4/<PEER1_IP>/tcp/27000",
    "/ip4/<PEER2_IP>/tcp/27000",
    "/ip4/<PEER3_IP>/tcp/27000",
]

[mempool.p2p]
listen_addr = "/ip4/0.0.0.0/tcp/28000"
persistent_peers = [
    "/ip4/<PEER1_IP>/tcp/28000",
    "/ip4/<PEER2_IP>/tcp/28000",
    "/ip4/<PEER3_IP>/tcp/28000",
]
```

Replace `<PEER_IP>` with the actual IP addresses of your validator peers.

<br/><br/>

#### **Start Emerald Node**

Start the Emerald consensus node:

```bash
emerald start \
  --home /home/emerald/.emerald \
  --config /home/emerald/.emerald/config/emerald.toml \
  --log-level info
```

The `--home` directory should contain:
- `<home>/config/config.toml` - Malachite BFT configuration
- `<home>/config/priv_validator_key.json` - Validator signing key
- `<home>/config/genesis.json` - Malachite BFT genesis file

An example Malachite BFT config file is provided: [malachitebft-config.toml](malachitebft-config.toml)

The `--config` flag should contain the explicit file path to the Emerald config:
- Example: `--config=/home/emerald/.emerald/config/emerald.toml`

<br/><br/>

#### **Emerald Config**

A sample Emerald config file has been provided: [emerald-config.toml](emerald-config.toml). 

This is where you define how Emerald connects to Reth. Make sure to fill in the Reth http and authrpc address.

Also make sure to place the JWT token that Reth is using in the JWT file path in Emerald config file, this JWT token needs to be the same so they can communicate.

<br/><br/>

#### **Key Ports**

- **27000**: Consensus P2P communication (which port to accept incoming traffic on)
- **28000**: Mempool P2P communication  (which port to accept incoming traffic on)
- **30000**: Prometheus metrics endpoint port

<br/><br/>

#### **Peering**

In the Malachite BFT config.toml you will need to fill in the 2 sections (consensus.p2p and mempool.p2p) `persistent_peers` array.
It uses the format `/ip4/<IP_ADDRESS_TO_REMOTE_PEER>/tcp/<PORT_FOR_REMOTE_PEER>`. Make sure to fill in all peers in the testnet.

<br/><br/>

#### **Monitoring**

Emerald exposes Prometheus metrics on port 30000 (configurable in `config.toml`):

```bash
curl http://<IP>:30000/metrics
```

<br/><br/>

#### **Systemd Service**

For production deployments, use systemd to manage the Emerald process. See [emerald.systemd.service.example](emerald.systemd.service.example) for a complete service configuration.

---

### Security Notes

- Make sure no ports are exposed to the internet and all traffic is secured with VPCs or VPN tunnels.

